.\" cloudnbd 0.1 man page
.TH cloudnbd 1 "29 Oct 2011" "Mansour"
.SH NAME
cloudnbd \- NBD server with cloud storage as backend
.SH SYNOPSIS
.nf
\fBcloudnbd\fP [\fB-h\fP] [\fB-v\fP]

\fBcloudnbd\fP [\fIoption\fP] \fIcommand\fP [\fB\-h\fP] \&.\&.\&.

\fBcloudnbd\fP [\fIoption\fP] \fBclose\fP \
\fIbackend\fP \
\fIvolume\fP

\fBcloudnbd\fP [\fIoption\fP] \fBcloseall\fP

\fBcloudnbd\fP [\fIoption\fP] \fBdelete\fP \
[\fIauth_option\fP] \
[\fB\-\-yes\fP] \
[\fB\-t\fP \fIcount\fP] \
\fIbackend\fP \
\fIvolume\fP

\fBcloudnbd\fP [\fIoption\fP] \fBinfo\fP \
[\fIauth_option\fP] \
\fIbackend\fP \
\fIvolume\fP

\fBcloudnbd\fP [\fIoption\fP] \fBinit\fP \
[\fIauth_option\fP] \
[\fB\-b\fP \fIsize\fP] \
\fIbackend\fP \
\fIvolume\fP \
\fIsize\fP

\fBcloudnbd\fP [\fIoption\fP] \fBlist\fP

\fBcloudnbd\fP [\fIoption\fP] \fBopen\fP \
[\fIauth_option\fP] \
[\fB\-s\fP \fIsize\fP] \
[\fB\-i\fP \fIip\fP] \
[\fB\-p\fP \fIport\fP] \
[\fB\-t\fP \fIcount\fP] \
[\fB\-r\fP \fIcount\fP] \
[\fB\-e\fP \fIsize\fP] \
[\fB\-\-foreground\fP] \
\fIbackend\fP \
\fIvolume\fP

\fBcloudnbd\fP [\fIoption\fP] \fBpasswd\fP \
[\fIauth_option\fP] \
\fIbackend\fP \
\fIvolume\fP

\fBcloudnbd\fP [\fIoption\fP] \fBresize\fP \
[\fIauth_option\fP] \
[\fB\-u\fP] \
\fIbackend\fP \
\fIvolume\fP \
\fIsize\fP

\fBcloudnbd\fP [\fIoption\fP] \fBstat\fP \
\fIbackend\fP \
\fIvolume\fP
.fi
.SH DESCRIPTION
\fBcloudnbd\fP provides access to cloud storage systems through Network
Block Device (NBD) driver of GNU/Linux kernel. NBD is a client-server
architecture and cloudnbd acts as the server. The client is provided by
NBD tools called \fInbd-client (1)\fP. The usual setup is to run
cloudnbd which connects to the cloud interface of the storage provider
and have nbd-client connect to it and bind the connection to an NBD
block device (e.g. /dev/nbd0). The block device then may be used just
like an ordinary one. One can format it with a file system, mount it and
read/write files from/to it.

Currently cloudnbd implements access to Google Storage for Developers
only. Amazon S3, while being more popular, lacks the read-after-write
consistency gaurantee and therefore is not yet implemented in cloudnbd.
All the \fIcommand\fPs that connect to the backend storage must be given
the name of the backend using \fIbackend\fP argument. See \fIBACKENDS\fP
section for more details.

\fIvolume\fP refers to the backend dependent path to the volume. See
\fIBACKENDS\fP section for more details.

All \fIsize\fP arguments follow the same format. Following variations
are supported:
.PP
.IP "1024"
means 1024 bytes
.IP "4K"
means 4000 bytes. Other letters that can be used are M, G, T, P. They
stand for Mega, Giga, Tera and Peta respectively.
.PP
.SH COMMANDS
.PP
.IP "\fBclose\fP"
Close an open volume. This command blocks until the open cloudnbd
instance has flushed all its dirty cache and is terminated.
.IP "\fBcloseall\fP"
Close all open volumes. This command blocks until all the open cloudnbd
instances have flushed their dirty caches and are terminated.
.IP "\fBdelete\fP"
Delete a volume's metadata and block data from the backend storage. When
the delete operation starts, it marks the volume as deleted by adding a
piece of metadata. If the delete operation is interrupted before
completion, the volume will not be openable. This is to prevent access
to possibly corrupted volume due to missing block data. If metadata of
the volume is corrupted and/or you have forgotten the password, use
\fB\-\-yes\fP option to force delete.
.IP "\fBinfo\fP"
Show the metadata of a volume.
.IP "\fBinit\fP"
Initialize a new volume. This is same as volume creation. Initializing a
volume consists of writing a metadata in the backend storage which
amongst other things, contains the encryption key and size of the
volume. To change the volume size, use \fBresize\fP command. No actual
block data is written at this stage, and thus regardless of the size
specified, the initialization runs in constant time.
.IP "\fBlist\fP"
Show the list of currently open volumes.
.IP "\fBopen\fP"
Open a volume and run an NBD server on the specified \fIport\fP. After a
volume is opened, \fInbd-client (1)\fP can be used to connect to it and
bind the connection to an NBD block device. By default, the server runs
as daemon process. You can use the \fBlist\fP command to see a list of
open volumes. To close an open volume, use either \fBclose\fP or
\fBcloseall\fP commands. To get statistics on an open volume use
\fBstat\fP command.
.IP "\fBpasswd\fP"
Change the encryption password on a volume. Changing password only
re-encrypts the metadata which holds the encryption key for blocks.
Therefore this command runs in constant time regardless of amount of
data held on the volume.
.IP "\fBresize\fP"
Change the default volume size reported to NBD client when the volume is
opened. Unless used with \fB-u\fP option, this command does NOT touch
the block data.
.IP "\fBstat\fP"
Show statistics on an open volume. Some useful statistics are the number
of requests sent/received, as well as the amount of data that has so far
been transferred. To get a list of open volumes, use \fBlist\fP command.
.PP
.SH GENERAL OPTIONS
.PP
These \fIoption\fPs must be specified \fIbefore\fP the \fIcommand\fP name.
.PP
.IP "\fB\-h\fP, \fB\-\-help\fP"
Shows the list of all available commands as well as help for the
\fIGENERAL OPTIONS\fP.
.IP "\fB\-F\fP \fIpath\fP, \fB\-\-path\fP \fIpath\fP"
Specifies the path to custom config file. If this option is specified,
the default config files are ignored. See \fIFILES\fP section for
location of config files.
.PP
These options must be specified \fIafter\fP the \fIcommand\fP name.
.PP
.IP "\fB\-h\fP, \fB\-\-help\fP"
Shows the help for the specified command.
.SH AUTH OPTIONS
Following \fIauth_option\fPs apply to all \fIbackends\fP. See
\fIBACKENDS\fP section for details specific to each backend.
.PP
.IP "\fB\-a\fP \fIkey\fP, \fB\-\-access\-key\fP \fIkey\fP"
Access key which depending on which backend is used, is analogous to the
user name of the storage provider.
.IP "\fB\-k\fP \fIkey\fP, \fB\-\-secret\-key\fP \fIkey\fP"
Secret key which depending on which backend is used, is analogous to the
password for the storage provider.
.IP "\fB\-y\fP \fIpassphrase\fP, \fB\-\-passphrase\fP \fIpassphrase\fP"
Passphrase based on which \fBcloudnbd\fP encrypts the data before
sending it to the backend.
.PP
.SH DELETE OPTIONS
.PP
.IP "\fB\-\-yes\fP \fIkey\fP"
Suppresses delete confirmations. Also, when specified, does not validate
the passphrase and even the presence of the actual volume on the cloud
storage. This is useful for when the metadata is corrupted/deleted from
the storage while the block data still exists.
.IP "\fB\-t\fP \fIcount\fP, \fB\-\-threads\fP \fIcount\fP"
Number of delete threads. Note that a certain backend may group delete
requests and only send a single delete request to the backend storage.
Therefore the net effect of increasing this count is dependent upon the
backend being used. See \fIBACKENDS\fP for behavior of each backend in
respect to \fBdelete\fP command.
.PP
.SH INIT OPTIONS
.PP
.IP "\fIsize\fP"
Size of the volume as reported to NBD client. In other words, this is
just a default volume size kept as metadata in the volume. When the
volume is opened for use, this is the size that is reported to NBD
client by default. You may choose to use a different volume size when
opening the volume using \fB-s\fP option of \fBopen\fP command.
.IP "\fB\-b\fP \fIsize\fP, \fB\-\-block\-size\fP \fIsize\fP"
Block size of blocks as stored on the cloud. Note that this is different
to the block size at the block device level. The latter is specified
using \fB-b\fP command line option of \fInbd-client\fP. Choosing large
block size on the cloud lowers the number of requests but increases the
amount of bandwidth required when random read/writes are performed.
Choosing small block size has the opposite effect. Also note that the
block size cannot be changed after the volume is initialized. The
default block size is 65536 bytes.
.PP
.SH OPEN OPTIONS
.PP
.IP "\fB\-s\fP \fIsize\fP, \fB\-\-size\fP \fIsize\fP"
Size of the volume as reported to NBD client. Most often this option is
not needed as the default volume size to report is saved as metadata in
the volume at the time of initialisation.
.IP "\fB\-i\fP \fIip\fP, \fB\-\-bind-address\fP \fIip\fP"
IP address cloudnbd will be bound to. By default it is bound to
all interfaces.
.IP "\fB\-p\fP \fIport\fP, \fB\-\-port\fP \fIport\fP"
Port cloudnbd will listen on. The default port is 7323.
.IP "\fB\-t\fP \fIcount\fP, \fB\-\-threads\fP \fIcount\fP"
Number of write threads. Since write requests are cached on the memory
before being sent to the backend storage, write requests can run in
parallel after a cache flush is needed. Depending on the round trip time
of your internet connection and the volume block size, you might need to
adjust this value to get the highest upload speeds. Generally, the
higher thread count means faster upload speed. The default is 10
threads.
.IP "\fB\-r\fP \fIcount\fP, \fB\-\-read\-ahead\fP \fIcount\fP"
Number of read ahead threads. Every time a block is read, cloudnbd
downloades the \fIcount\fP number of successive blocks to improve the
performance of subsequent reads. Using a higher read ahead count will
increase the performance of sequential reads. However, for random reads,
it will only increase the bandwidth usage and could possibly slow down
read performance. The default is 5 read ahead threads.
.IP "\fB\-e\fP \fIsize\fP, \fB\-\-max\-cache\fP \fIsize\fP"
Maximum amount of in-memory cache to use for storing block data. Higher
sizes may increase the read/write performance while decreasing network
traffic. Also, a high size will lead to higher data loss in case of a
crash. By default, 16 Megabytes is used for cache.
.IP "\fB\-\-foreground\fP"
Run cloudnbd in the foreground. This is useful for debugging purposes.
By default, cloudnbd runs as a daemon process.
.PP
.SH PASSWD OPTIONS
.PP
.IP "\fB\-p\fP \fIpassphrase\fP, \fB\-\-passphrase\fP \fIpassphrase\fP"
New password to use for the volume. The new password is used to
re-encrypt the metadata which includes the encryption key for the
blocks. Therefore this operation runs in constant time regardless of how
much data is stored in the volume.
.PP
.SH RESIZE OPTIONS
.PP
.IP "\fIsize\fP"
New size of the volume. This only changes the metadata unless \fB-u\fP
is specified. The consequence of this is that if the volume is resized
to a smaller size, the block data stays untouched. When the volume is
resized back to its old size, the blocks can be used again.
.IP "\fB\-u\fP, \fB\-\-cleanup\fP"
If the new size is smaller, all the now unused blocks will be deleted.
.PP
.SH BACKENDS
.PP
.IP "Google Storage for Developers"
To use this backend, use \fBgs\fP as \fIbackend\fP for relevant
commands. The \fIvolume\fP has the format <bucket>/<key-prefix>.
<bucket> is the name of the Google Storage bucket where the volume is to
reside in. <key-prefix> is the string that all the keys used by cloudnbd
will be prefixed with. Note that a slash character "/" is appened to
<key-prefix>. <bucket> must not contain "/". <key-prefix> may contain
"/".
.br
Example: "jennyt/documents" refers to "jennyt" bucket with prefix of
"documents".
.br
NOTE you must ensure you have some type of system clock synchronization
such as NTP to avoid errors caused by large differences in clock time
between your machine and Google servers.
.SH FILES
.nf
/etc/cloudnbd.conf
~/.cloudnbd
.fi
.SH SEE ALSO
.nf
.I nbd-client (1)
https://github.com/oxplot/cloudnbd
.fi
.SH AUTHORS
.nf
See the AUTHORS file included with this program.
.SH BUGS
.nf
If you come across any bugs, please send a description of it to
mansour@oxplot.com
.fi
